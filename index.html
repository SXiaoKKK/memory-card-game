<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è®°å¿†å¡ç‰‡é…å¯¹</title>
    <!-- å¼•å…¥Howler.jsåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Arial Rounded MT Bold', 'Helvetica Rounded', Arial, sans-serif;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            padding: 30px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* åŠ è½½ç•Œé¢ */
        #loading-screen {
            height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loading-logo {
            font-size: 3rem;
            font-weight: bold;
            color: #6e8efb;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .loading-bar {
            width: 80%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #6e8efb, #a777e3);
            width: 0%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* ä¸»èœå•ç•Œé¢ */
        .game-title {
            font-size: 2.5rem;
            color: #6e8efb;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .menu-button {
            width: 100%;
            max-width: 300px;
            margin: 15px auto;
            padding: 18px;
            font-size: 1.3rem;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(110, 142, 251, 0.3);
            display: block;
        }

        .menu-button:hover,
        .menu-button:active {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(110, 142, 251, 0.4);
        }

        /* éš¾åº¦é€‰æ‹©ç•Œé¢ */
        .difficulty-list {
            list-style: none;
            margin: 30px 0;
        }

        .difficulty-item {
            padding: 20px;
            margin: 15px auto;
            max-width: 300px;
            background: #f8f9fa;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .difficulty-item:hover,
        .difficulty-item.selected {
            border-color: #6e8efb;
            background: #edf2ff;
            transform: scale(1.02);
        }

        .difficulty-name {
            font-size: 1.5rem;
            color: #444;
            margin-bottom: 5px;
        }

        .difficulty-desc {
            color: #666;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        /* æ¸¸æˆç•Œé¢ */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .stats {
            display: flex;
            gap: 20px;
            font-size: 1.1rem;
            color: #666;
        }

        .stat {
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 10px;
            min-width: 80px;
        }

        .cards-grid {
            display: grid;
            gap: 12px;
            justify-content: center;
            margin: 30px 0;
        }

        .card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card.matched {
            transform: rotateY(180deg);
            opacity: 0.7;
            cursor: default;
        }

        /* ä¿®æ”¹å¡ç‰‡èƒŒé¢ï¼šåŒ¹é…æˆåŠŸæ—¶ç§»é™¤é—®å· */
        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
        }

        .card-back {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
        }

        /* ä¿®æ”¹å¡ç‰‡èƒŒé¢é—®å·æ ·å¼ */
        .card .card-back::after {
            content: "?";
        }

        /* åŒ¹é…æˆåŠŸæ—¶éšè—é—®å· */
        .card.matched .card-back::after {
            content: "";
        }

        .card-front {
            background: white;
            transform: rotateY(180deg);
            color: #6e8efb;
        }

        /* æ¸¸æˆç»“æŸç•Œé¢ */
        .result-title {
            font-size: 2.5rem;
            color: #4CAF50;
            margin: 20px 0;
        }

        .result-stats {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 20px;
            margin: 30px auto;
            max-width: 400px;
        }

        .result-stat {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 1.2rem;
        }

        .result-stat:last-child {
            border-bottom: none;
        }

        .highlight {
            color: #6e8efb;
            font-weight: bold;
        }

        /* è®¾ç½®ç•Œé¢ */
        .settings-group {
            max-width: 400px;
            margin: 30px auto;
            text-align: left;
        }

        .setting-item {
            margin: 25px 0;
        }

        .setting-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #6e8efb;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* éŸ³ä¹æ§åˆ¶æŒ‰é’® */
        .music-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6e8efb;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            #game-container {
                border-radius: 20px;
            }

            .screen {
                padding: 20px;
            }

            .game-title {
                font-size: 2rem;
            }

            .menu-button {
                padding: 15px;
                font-size: 1.1rem;
            }

            .cards-grid {
                gap: 8px;
            }

            .music-toggle {
                top: 10px;
                right: 10px;
                width: 35px;
                height: 35px;
            }
        }

        @media (max-width: 400px) {
            .game-header {
                flex-direction: column;
                gap: 15px;
            }

            .stats {
                flex-wrap: wrap;
                justify-content: center;
            }

            .card-front,
            .card-back {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- èƒŒæ™¯éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <button id="music-toggle" class="music-toggle" onclick="toggleMusic()">â™ª</button>

    <div id="game-container">
        <!-- åŠ è½½ç•Œé¢ -->
        <div id="loading-screen" class="screen active">
            <div class="loading-logo">è®°å¿†å¡ç‰‡é…å¯¹</div>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
            <div>åŠ è½½ä¸­...</div>
        </div>

        <!-- ä¸»èœå•ç•Œé¢ -->
        <div id="main-menu" class="screen">
            <h1 class="game-title">è®°å¿†å¡ç‰‡é…å¯¹</h1>
            <button class="menu-button" onclick="playButtonSound(); showScreen('difficulty-screen')">å¼€å§‹æ¸¸æˆ</button>
            <button class="menu-button" onclick="playButtonSound(); showScreen('records-screen')">æœ€ä½³çºªå½•</button>
            <button class="menu-button" onclick="playButtonSound(); showScreen('settings-screen')">æ¸¸æˆè®¾ç½®</button>
        </div>

        <!-- éš¾åº¦é€‰æ‹©ç•Œé¢ -->
        <div id="difficulty-screen" class="screen">
            <h2>é€‰æ‹©éš¾åº¦</h2>
            <ul class="difficulty-list">
                <li class="difficulty-item" onclick="playButtonSound(); selectDifficulty('easy')">
                    <div class="difficulty-name">ç®€å•</div>
                    <div class="difficulty-desc">4Ã—4 ç½‘æ ¼ | 8å¯¹å¡ç‰‡</div>
                </li>
                <li class="difficulty-item" onclick="playButtonSound(); selectDifficulty('medium')">
                    <div class="difficulty-name">ä¸­ç­‰</div>
                    <div class="difficulty-desc">5Ã—6 ç½‘æ ¼ | 15å¯¹å¡ç‰‡</div>
                </li>
                <li class="difficulty-item" onclick="playButtonSound(); selectDifficulty('hard')">
                    <div class="difficulty-name">å›°éš¾</div>
                    <div class="difficulty-desc">6Ã—8 ç½‘æ ¼ | 24å¯¹å¡ç‰‡</div>
                </li>
            </ul>
            <div class="action-buttons">
                <button class="menu-button" onclick="playButtonSound(); startGame()" style="flex: 1;">å¼€å§‹æ¸¸æˆ</button>
                <button class="menu-button" onclick="playButtonSound(); goBack()"
                    style="flex: 1; background: #888;">è¿”å›</button>
            </div>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div class="stats">
                    <div class="stat">æ—¶é—´: <span id="timer">00:00</span></div>
                    <div class="stat">æ­¥æ•°: <span id="moves">0</span></div>
                </div>
                <button class="menu-button" style="padding: 10px 20px; font-size: 1rem;"
                    onclick="playButtonSound(); showScreen('game-menu')">èœå•</button>
            </div>
            <div id="cards-container" class="cards-grid"></div>
        </div>

        <!-- æ¸¸æˆèœå• -->
        <div id="game-menu" class="screen">
            <h2>æ¸¸æˆèœå•</h2>
            <button class="menu-button" onclick="playButtonSound(); showScreen('settings-screen')">æ¸¸æˆè®¾ç½®</button>
            <button class="menu-button" onclick="playButtonSound(); restartGame()">é‡æ–°å¼€å§‹</button>
            <button class="menu-button" onclick="playButtonSound(); showScreen('difficulty-screen')">éš¾åº¦é€‰æ‹©</button>
            <button class="menu-button" onclick="playButtonSound(); showScreen('main-menu')">é€€å‡ºæ¸¸æˆ</button>
            <button class="menu-button" onclick="playButtonSound(); goBack()" style="background: #888;">è¿”å›æ¸¸æˆ</button>
        </div>

        <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
        <div id="result-screen" class="screen">
            <div class="result-title">æ­å–œé€šå…³ï¼</div>
            <div class="result-stats">
                <div class="result-stat">
                    <span>ç”¨æ—¶:</span>
                    <span id="final-time" class="highlight">00:00</span>
                </div>
                <div class="result-stat">
                    <span>æ­¥æ•°:</span>
                    <span id="final-moves" class="highlight">0</span>
                </div>
                <div class="result-stat">
                    <span>æœ€ä½³æ—¶é—´:</span>
                    <span id="best-time" class="highlight">--:--</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="menu-button" onclick="playButtonSound(); restartGame()">å†ç©ä¸€æ¬¡</button>
                <button class="menu-button" onclick="playButtonSound(); showScreen('main-menu')">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>

        <!-- æœ€ä½³çºªå½•ç•Œé¢ -->
        <div id="records-screen" class="screen">
            <h2>æœ€ä½³çºªå½•</h2>
            <div class="result-stats">
                <div class="result-stat">
                    <span>ç®€å•éš¾åº¦:</span>
                    <span id="record-easy" class="highlight">--:--</span>
                </div>
                <div class="result-stat">
                    <span>ä¸­ç­‰éš¾åº¦:</span>
                    <span id="record-medium" class="highlight">--:--</span>
                </div>
                <div class="result-stat">
                    <span>å›°éš¾éš¾åº¦:</span>
                    <span id="record-hard" class="highlight">--:--</span>
                </div>
            </div>
            <button class="menu-button" onclick="playButtonSound(); goBack()" style="margin-top: 30px;">è¿”å›</button>
        </div>

        <!-- è®¾ç½®ç•Œé¢ -->
        <div id="settings-screen" class="screen">
            <h2>æ¸¸æˆè®¾ç½®</h2>
            <div class="settings-group">
                <div class="setting-item">
                    <div class="setting-label">
                        <span>æ¸¸æˆéŸ³æ•ˆ</span>
                        <span id="sfx-value">50%</span>
                    </div>
                    <input type="range" class="slider" id="sfx-slider" min="0" max="100" value="50"
                        oninput="playSliderSound(); updateSFX(this.value)">
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <span>èƒŒæ™¯éŸ³ä¹</span>
                        <span id="music-value">50%</span>
                    </div>
                    <input type="range" class="slider" id="music-slider" min="0" max="100" value="50"
                        oninput="playSliderSound(); updateMusic(this.value)">
                </div>
            </div>
            <button class="menu-button" onclick="playButtonSound(); saveSettings()"
                style="margin-top: 30px;">ä¿å­˜è®¾ç½®</button>
            <button class="menu-button" onclick="playButtonSound(); goBack()"
                style="background: #888; margin-top: 15px;">è¿”å›</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            difficulty: 'easy',
            selectedDifficulty: null,
            cards: [],
            flippedCards: [],
            matchedPairs: 0,
            moves: 0,
            time: 0,
            timer: null,
            isPlaying: true,
            canFlip: true,
            isMusicPlaying: true,
            settings: {
                sfx: 50,
                music: 50
            },
            // é¡µé¢å†å²æ ˆï¼Œç”¨äºè®°å½•è®¿é—®è·¯å¾„
            screenHistory: []
        };

        // éš¾åº¦é…ç½®
        const difficulties = {
            easy: { rows: 4, cols: 4, pairs: 8 },
            medium: { rows: 5, cols: 6, pairs: 15 },
            hard: { rows: 6, cols: 8, pairs: 24 }
        };

        // Emojiå›¾æ ‡é›†ï¼ˆå¯æ ¹æ®éœ€è¦æ‰©å±•ï¼‰
        const emojis = ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯',
            'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦„',
            'ğŸ™', 'ğŸ ', 'ğŸ¬', 'ğŸ³', 'ğŸ¦ˆ', 'ğŸ¦’', 'ğŸ¦', 'ğŸ˜', 'ğŸ¦›', 'ğŸ¦˜'];

        // ================ éŸ³é¢‘èµ„æºé…ç½® ================
        // æ³¨ï¼šä»¥ä¸‹é“¾æ¥æ¥è‡ªå…è´¹çš„åœ¨çº¿éŸ³é¢‘ç´ æèµ„æº[citation:1]ï¼Œä½†å»ºè®®åœ¨æ­£å¼é¡¹ç›®ä¸­ç¡®è®¤å…¶é•¿æœŸå¯ç”¨æ€§æˆ–è‡ªè¡Œæ‰˜ç®¡ã€‚
        const audioResources = {
            // èƒŒæ™¯éŸ³ä¹ - æ¥è‡ªå…è´¹ç´ æç½‘ç«™çš„è½»éŸ³ä¹
            bgm: {
                url: 'https://cdn.pixabay.com/download/audio/2025/09/08/audio_69b2e79131.mp3?filename=beautiful_dream-401645.mp3',
                howl: null,
                volume: 0.3
            },
            // æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆ
            buttonClick: {
                url: 'https://assets.mixkit.co/active_storage/sfx/1109/1109.wav',
                howl: null
            },
            // ç¿»ç‰ŒéŸ³æ•ˆ
            cardFlip: {
                url: 'https://assets.mixkit.co/active_storage/sfx/1317/1317.wav',
                howl: null
            },
            // åŒ¹é…æˆåŠŸéŸ³æ•ˆ
            cardMatch: {
                url: 'https://assets.mixkit.co/active_storage/sfx/1108/1108.wav',
                howl: null
            }
        };

        // ================ éŸ³é¢‘ç®¡ç†å‡½æ•° ================
        // é¢„åŠ è½½æ‰€æœ‰éŸ³é¢‘èµ„æº
        function preloadAudioResources() {
            console.log('å¼€å§‹é¢„åŠ è½½éŸ³é¢‘èµ„æº...');
            let loadedCount = 0;
            const totalResources = Object.keys(audioResources).length;

            for (const key in audioResources) {
                const resource = audioResources[key];

                // åˆ›å»ºHowlå®ä¾‹è¿›è¡Œé¢„åŠ è½½[citation:5]
                resource.howl = new Howl({
                    src: [resource.url],
                    preload: true,
                    volume: key === 'bgm' ? (gameState.settings.music / 100) * resource.volume : (gameState.settings.sfx / 100),
                    loop: key === 'bgm',
                    onload: function () {
                        loadedCount++;
                        console.log(`éŸ³é¢‘åŠ è½½æˆåŠŸ: ${key}`);
                        updateLoadingProgress(loadedCount, totalResources);
                        if(key == 'bgm'){
                            playBackgroundMusic();
                        }
                    },
                    onloaderror: function (id, error) {
                        console.error(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${key}`, error);
                        loadedCount++;
                        updateLoadingProgress(loadedCount, totalResources);
                    }
                });
            }
        }

        // æ›´æ–°åŠ è½½è¿›åº¦
        function updateLoadingProgress(loaded, total) {
            const progress = Math.min(100, Math.round((loaded / total) * 100));
            const progressBar = document.querySelector('.loading-progress');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }

            // æ‰€æœ‰éŸ³é¢‘åŠ è½½å®Œæˆåï¼Œæ˜¾ç¤ºä¸»èœå•
            if (loaded >= total) {
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    gameState.screenHistory = ['main-menu'];
                    showScreen('main-menu');
                }, 500);
            }
        }

        // æ’­æ”¾æŒ‰é’®éŸ³æ•ˆ
        function playButtonSound() {
            if (audioResources.buttonClick.howl && gameState.settings.sfx > 0) {
                audioResources.buttonClick.howl.volume(gameState.settings.sfx / 100);
                audioResources.buttonClick.howl.play();
            }
        }

        // æ’­æ”¾æ»‘å—éŸ³æ•ˆ
        function playSliderSound() {
            // ä½¿ç”¨æŒ‰é’®éŸ³æ•ˆæ›¿ä»£
            playButtonSound();
        }

        // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
        function playFlipSound() {
            if (audioResources.cardFlip.howl && gameState.settings.sfx > 0) {
                audioResources.cardFlip.howl.volume(gameState.settings.sfx / 100);
                audioResources.cardFlip.howl.play();
            }
        }

        // æ’­æ”¾åŒ¹é…æˆåŠŸéŸ³æ•ˆ
        function playMatchSound() {
            if (audioResources.cardMatch.howl && gameState.settings.sfx > 0) {
                audioResources.cardMatch.howl.volume(gameState.settings.sfx / 100);
                audioResources.cardMatch.howl.play();
            }
        }

        // æ’­æ”¾èƒŒæ™¯éŸ³ä¹
        function playBackgroundMusic() {
            if (!gameState.isMusicPlaying || gameState.settings.music === 0) return;

            if (audioResources.bgm.howl && !audioResources.bgm.howl.playing()) {
                // è®¡ç®—å®é™…éŸ³é‡ï¼ˆè®¾ç½®å€¼ * åŸºç¡€éŸ³é‡ï¼‰
                const actualVolume = (gameState.settings.music / 100) * audioResources.bgm.volume;
                audioResources.bgm.howl.volume(actualVolume);
                audioResources.bgm.howl.play();
                console.log('èƒŒæ™¯éŸ³ä¹å¼€å§‹æ’­æ”¾');
            }
        }

        // åœæ­¢èƒŒæ™¯éŸ³ä¹
        function stopBackgroundMusic() {
            if (audioResources.bgm.howl && audioResources.bgm.howl.playing()) {
                audioResources.bgm.howl.stop();
                console.log('èƒŒæ™¯éŸ³ä¹åœæ­¢');
            }
        }

        // åˆ‡æ¢èƒŒæ™¯éŸ³ä¹
        function toggleMusic() {
            gameState.isMusicPlaying = !gameState.isMusicPlaying;
            const toggleBtn = document.getElementById('music-toggle');

            if (gameState.isMusicPlaying && gameState.settings.music > 0) {
                playBackgroundMusic();
                toggleBtn.textContent = 'â™ª';
                toggleBtn.style.background = '#6e8efb';
            } else {
                stopBackgroundMusic();
                toggleBtn.textContent = 'ğŸ”‡';
                toggleBtn.style.background = '#888';
            }
        }

        // æ›´æ–°èƒŒæ™¯éŸ³ä¹éŸ³é‡
        function updateBackgroundMusicVolume() {
            if (audioResources.bgm.howl) {
                const actualVolume = (gameState.settings.music / 100) * audioResources.bgm.volume;
                audioResources.bgm.howl.volume(actualVolume);

                // å¦‚æœéŸ³ä¹åº”è¯¥æ’­æ”¾ä½†æ²¡åœ¨æ’­æ”¾ï¼Œåˆ™å¼€å§‹æ’­æ”¾
                if (gameState.isMusicPlaying && gameState.settings.music > 0 && !audioResources.bgm.howl.playing()) {
                    playBackgroundMusic();
                }
            }
        }

        // é¡µé¢å†å²ç®¡ç†
        function pushScreenToHistory(screenId) {
            // ä¸é‡å¤æ·»åŠ ç›¸åŒé¡µé¢
            if (gameState.screenHistory.length === 0 ||
                gameState.screenHistory[gameState.screenHistory.length - 1] !== screenId) {
                gameState.screenHistory.push(screenId);
            }
        }

        function getPreviousScreen() {
            if (gameState.screenHistory.length > 1) {
                // ç§»é™¤å½“å‰é¡µé¢
                gameState.screenHistory.pop();
                // è¿”å›ä¸Šä¸€ä¸ªé¡µé¢
                return gameState.screenHistory[gameState.screenHistory.length - 1];
            }
            return 'main-menu';
        }

        // å±å¹•åˆ‡æ¢
        function showScreen(screenId) {
            // è®°å½•é¡µé¢å†å²
            pushScreenToHistory(screenId);

            // éšè—æ‰€æœ‰å±å¹•
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
                screen.style.display = 'none';
            });

            // æ˜¾ç¤ºç›®æ ‡å±å¹•
            const targetScreen = document.getElementById(screenId);
            targetScreen.style.display = 'block';
            setTimeout(() => {
                targetScreen.classList.add('active');
            }, 10);
        }

        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            const previousScreen = getPreviousScreen();
            showScreen(previousScreen);
        }

        // åˆå§‹åŒ–
        function init() {
            // åŠ è½½è®¾ç½®å’Œè®°å½•
            loadSettings();
            loadRecords();

            // é¢„åŠ è½½éŸ³é¢‘èµ„æºï¼ˆè¿™ä¼šè§¦å‘åŠ è½½è¿›åº¦æ›´æ–°ï¼‰
            preloadAudioResources();
        }

        // é€‰æ‹©éš¾åº¦
        function selectDifficulty(difficulty) {
            gameState.selectedDifficulty = difficulty;

            // æ›´æ–°UI
            document.querySelectorAll('.difficulty-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            if (!gameState.selectedDifficulty) {
                gameState.selectedDifficulty = 'easy';
                document.querySelector('.difficulty-item').classList.add('selected');
            }

            gameState.difficulty = gameState.selectedDifficulty;
            resetGame();
            createCards();
            showScreen('game-screen');
            startTimer();

            // ç¡®ä¿èƒŒæ™¯éŸ³ä¹æ’­æ”¾
            if (gameState.isMusicPlaying && gameState.settings.music > 0) {
                playBackgroundMusic();
            }
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            gameState.cards = [];
            gameState.flippedCards = [];
            gameState.matchedPairs = 0;
            gameState.moves = 0;
            gameState.time = 0;
            gameState.isPlaying = true;
            gameState.canFlip = true;

            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }

            updateStats();
        }

        // åˆ›å»ºå¡ç‰‡
        function createCards() {
            const config = difficulties[gameState.difficulty];
            const totalCards = config.rows * config.cols;
            const pairs = config.pairs;

            // ç”Ÿæˆå¡ç‰‡å¯¹
            let cardValues = [];
            const selectedEmojis = emojis.slice(0, pairs);

            // æ¯å¯¹å¡ç‰‡ä¸¤ä¸ªç›¸åŒçš„emoji
            selectedEmojis.forEach(emoji => {
                cardValues.push(emoji, emoji);
            });

            // æ´—ç‰Œç®—æ³•
            for (let i = cardValues.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardValues[i], cardValues[j]] = [cardValues[j], cardValues[i]];
            }

            // åˆ›å»ºå¡ç‰‡å…ƒç´ 
            const container = document.getElementById('cards-container');
            container.innerHTML = '';

            // è®¾ç½®ç½‘æ ¼å¸ƒå±€
            container.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;
            container.style.gridTemplateRows = `repeat(${config.rows}, 1fr)`;

            // ç”Ÿæˆå¡ç‰‡
            for (let i = 0; i < totalCards; i++) {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.index = i;
                card.dataset.value = cardValues[i] || '';

                // ä¿®æ”¹ï¼šå¡ç‰‡èƒŒé¢ä¸å†æœ‰é—®å·å†…å®¹ï¼Œé€šè¿‡CSSæ·»åŠ 
                card.innerHTML = `
                    <div class="card-back"></div>
                    <div class="card-front">${cardValues[i] || ''}</div>
                `;

                card.addEventListener('click', () => flipCard(card));
                container.appendChild(card);
                gameState.cards.push({
                    element: card,
                    value: cardValues[i],
                    isFlipped: false,
                    isMatched: false
                });
            }
        }

        // ç¿»è½¬å¡ç‰‡
        function flipCard(card) {
            if (!gameState.canFlip || !gameState.isPlaying) return;

            const index = parseInt(card.dataset.index);
            const cardState = gameState.cards[index];

            if (cardState.isFlipped || cardState.isMatched) return;

            // æ’­æ”¾ç¿»ç‰ŒéŸ³æ•ˆ
            playFlipSound();

            // ç¿»ç‰ŒåŠ¨ç”»
            card.classList.add('flipped');
            cardState.isFlipped = true;
            gameState.flippedCards.push(cardState);

            // å¦‚æœç¿»äº†ä¸¤å¼ ç‰Œï¼Œæ£€æŸ¥æ˜¯å¦åŒ¹é…
            if (gameState.flippedCards.length === 2) {
                gameState.moves++;
                updateStats();
                gameState.canFlip = false;

                setTimeout(checkMatch, 800);
            }
        }

        // æ£€æŸ¥åŒ¹é…
        function checkMatch() {
            const [card1, card2] = gameState.flippedCards;

            if (card1.value === card2.value) {
                // åŒ¹é…æˆåŠŸ
                card1.element.classList.add('matched');
                card2.element.classList.add('matched');
                card1.isMatched = true;
                card2.isMatched = true;

                // æ’­æ”¾åŒ¹é…æˆåŠŸéŸ³æ•ˆ
                playMatchSound();

                gameState.matchedPairs++;

                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                const config = difficulties[gameState.difficulty];
                if (gameState.matchedPairs === config.pairs) {
                    endGame();
                }
            } else {
                // åŒ¹é…å¤±è´¥ï¼Œç¿»å›å»
                card1.element.classList.remove('flipped');
                card2.element.classList.remove('flipped');
                card1.isFlipped = false;
                card2.isFlipped = false;
            }

            // é‡ç½®ç¿»ç‰ŒçŠ¶æ€
            gameState.flippedCards = [];
            gameState.canFlip = true;
        }

        // å¼€å§‹è®¡æ—¶
        function startTimer() {
            gameState.timer = setInterval(() => {
                gameState.time++;
                updateStats();
            }, 1000);
        }

        // æ›´æ–°æ¸¸æˆç»Ÿè®¡
        function updateStats() {
            document.getElementById('moves').textContent = gameState.moves;

            const minutes = Math.floor(gameState.time / 60).toString().padStart(2, '0');
            const seconds = (gameState.time % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${minutes}:${seconds}`;
        }

        // ç»“æŸæ¸¸æˆ
        function endGame() {
            gameState.isPlaying = false;
            clearInterval(gameState.timer);

            // æ˜¾ç¤ºç»“æœ
            const minutes = Math.floor(gameState.time / 60).toString().padStart(2, '0');
            const seconds = (gameState.time % 60).toString().padStart(2, '0');

            document.getElementById('final-time').textContent = `${minutes}:${seconds}`;
            document.getElementById('final-moves').textContent = gameState.moves;

            // æ›´æ–°æœ€ä½³çºªå½•
            updateBestRecord(gameState.difficulty, gameState.time);

            // æ˜¾ç¤ºç»“æœç•Œé¢
            setTimeout(() => {
                showScreen('result-screen');
            }, 1000);
        }

        // æ›´æ–°æœ€ä½³çºªå½•
        function updateBestRecord(difficulty, time) {
            const recordKey = `best_time_${difficulty}`;
            const bestTime = localStorage.getItem(recordKey);

            if (!bestTime || time < parseInt(bestTime)) {
                localStorage.setItem(recordKey, time.toString());
            }

            loadRecords();
        }

        // åŠ è½½æœ€ä½³çºªå½•
        function loadRecords() {
            const difficulties = ['easy', 'medium', 'hard'];
            difficulties.forEach(diff => {
                const time = localStorage.getItem(`best_time_${diff}`);
                const element = document.getElementById(`record-${diff}`);

                if (time) {
                    const minutes = Math.floor(time / 60).toString().padStart(2, '0');
                    const seconds = (time % 60).toString().padStart(2, '0');
                    element.textContent = `${minutes}:${seconds}`;
                } else {
                    element.textContent = '--:--';
                }
            });

            // æ›´æ–°æ¸¸æˆç»“æŸç•Œé¢çš„æœ€ä½³æ—¶é—´
            const bestTime = localStorage.getItem(`best_time_${gameState.difficulty}`);
            const bestTimeElement = document.getElementById('best-time');

            if (bestTime) {
                const minutes = Math.floor(bestTime / 60).toString().padStart(2, '0');
                const seconds = (bestTime % 60).toString().padStart(2, '0');
                bestTimeElement.textContent = `${minutes}:${seconds}`;
            }
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            resetGame();
            createCards();
            showScreen('game-screen');
            startTimer();
        }

        // æ›´æ–°éŸ³æ•ˆè®¾ç½®
        function updateSFX(value) {
            gameState.settings.sfx = value;
            document.getElementById('sfx-value').textContent = `${value}%`;

            // æ›´æ–°éŸ³æ•ˆéŸ³é‡
            if (audioResources.buttonClick.howl) {
                audioResources.buttonClick.howl.volume(value / 100);
            }
            if (audioResources.cardFlip.howl) {
                audioResources.cardFlip.howl.volume(value / 100);
            }
            if (audioResources.cardMatch.howl) {
                audioResources.cardMatch.howl.volume(value / 100);
            }
        }

        // æ›´æ–°éŸ³ä¹è®¾ç½®
        function updateMusic(value) {
            gameState.settings.music = value;
            document.getElementById('music-value').textContent = `${value}%`;
            updateBackgroundMusicVolume();
        }

        // åŠ è½½è®¾ç½®
        function loadSettings() {
            const savedSettings = localStorage.getItem('game_settings');
            if (savedSettings) {
                gameState.settings = JSON.parse(savedSettings);
                document.getElementById('sfx-slider').value = gameState.settings.sfx;
                document.getElementById('music-slider').value = gameState.settings.music;
                document.getElementById('sfx-value').textContent = `${gameState.settings.sfx}%`;
                document.getElementById('music-value').textContent = `${gameState.settings.music}%`;
            }
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            localStorage.setItem('game_settings', JSON.stringify(gameState.settings));
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
            goBack();
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        window.onload = init;

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†éŸ³é¢‘
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœèƒŒæ™¯éŸ³ä¹
                if (audioResources.bgm.howl && audioResources.bgm.howl.playing()) {
                    audioResources.bgm.howl.pause();
                }
            } else if (gameState.isMusicPlaying && gameState.settings.music > 0) {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤èƒŒæ™¯éŸ³ä¹
                if (audioResources.bgm.howl) {
                    audioResources.bgm.howl.play();
                }
            }
        });
    </script>
</body>

</html>
